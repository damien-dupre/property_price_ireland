---
title: Evaluation of property price fluctuaction according to geographical landmarks, an Dublin case study
author:
  - name: Alice Anonymous
    email: alice@example.com
    affiliation: Some Institute of Technology
    footnote: Corresponding Author
  - name: Bob Security
    email: bob@example.com
    affiliation: Another University
address:
  - code: Some Institute of Technology
    address: Department, Street, City, State, Zip
  - code: Another University
    address: Department, Street, City, State, Zip
abstract: |
  This is the abstract.

  It consists of two paragraphs.

journal: "An awesome journal"
date: "`r Sys.Date()`"
bibliography: mybibfile.bib
output: rticles::elsevier_article
header-includes:
  - \usepackage{float}
  - \usepackage{booktabs}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  cache.extra = knitr::rand_seed, 
  message = FALSE, 
  warning = FALSE, 
  error = FALSE, 
  echo = FALSE, 
  fig.align="left", 
  fig.pos = 'H')
# options
options(scipen=999)
gradian_col <- c('#3a53a4', '#68bd45','#ed1c24')
# tools
library(here)
library(lubridate)
library(readr)
# data wrangling
library(plyr)
library(dplyr)
# table design
library(kableExtra)
# figure design
library(ggplot2)
library(ggpubr)
library(ggridges)
# map tools
library(sf)
library(tmap)
library(lwgeom)
library(osmdata)
library(OpenStreetMap)
# statistical analysis
library(mgcv)
# custom function
source(here::here("my_viz.R"))
```

```{r data_upload}
data_raw <- readr::read_csv(here::here("data/PPR-ALL.csv")) %>%
  dplyr::rename(
    date_of_sale = `Date of Sale (dd/mm/yyyy)`,
    price = `Price (<U+0080>)`
  ) %>%
  dplyr::mutate(price = readr::parse_number(price)) %>%
  dplyr::mutate(date_of_sale = as.Date(date_of_sale, format = "%d/%m/%Y")) %>%
  dplyr::mutate(full_address = paste(Address, County, "Ireland")) %>%
  tibble::rowid_to_column("sale_id") %>%
  dplyr::mutate(year = lubridate::year(date_of_sale))

data_dublin <- data_raw %>%
  dplyr::filter(County == "Dublin")

data_dublin_geocoded_clean <-
  readr::read_rds(here::here("data/data_dublin_geocoded_clean.rds")) %>%
  dplyr::mutate(year_fact = as.factor(as.character(year)))

mean_dat <- mean(data_dublin_geocoded_clean$price)
sd_dat <- sd(data_dublin_geocoded_clean$price)

data_dublin_geocoded_clean <- data_dublin_geocoded_clean %>%
  dplyr::filter(price > mean_dat - sd_dat)# %>%
  #dplyr::filter(price < mean_dat + sd_dat)
# Map background
dublin_map <- openmap(
  c(max(data_dublin_geocoded_clean$lat),min(data_dublin_geocoded_clean$lng)),
  c(min(data_dublin_geocoded_clean$lat),max(data_dublin_geocoded_clean$lng)),
  minNumTiles=10) %>%
  openproj()
```

Introdution
==========================

To acquire a property is one of the most important achievement that individuals are seeking. It provides not only a housing security but also the feeling of being a landowner. However the access to the status of landowner is complicated because buying a property is the most expensive spending of in a lifetime. For this reason understanding the factors which are explaining how property prices evolve is a necessity.

Due to its geographic, economic and political situation, Ireland in general and Dublin in particular saw important changes in property prices in the last ten years. From a economic boom known as the "celtic tiger" in the 2000's, Ireland were deeply impacted by the 2007 economic crisis. With an expected GDP growth of 4% for 2019, property prices are back to their highest. Whereas this grow is moderated in Irish mainland, its capital Dublin is at the center of a housing crisis. Because of factors including Irish economic wealth, the presence of tec companies european headquarters such as Facebook or Google and the historic configuration of the city which low population density structure and underdeveloped public transportation, property prices became unaffordable to most of irish families.

In this paper we want to identify the spatio-temporal factors that influcenced the evolution of Dublin property prices. More precisely we want to highlight not only macroeconomical influences such as GDP but also the presence of econimical landmarks such as tec companies headquarters and public transportation system on property prices evoluation.

Method
==========================

Since the 1st January 2010, under the Property Services (Regulation) Act, all individuals aquering a property in Ireland has to declare it to Property Services Regulatory Authority (PSRA). It includes Date of Sale, Price and Address of all residential properties purchased in Ireland as declared to the Revenue Commissioners for stamp duty purposes (https://propertypriceregister.ie). It must be noticed that data is filed electronically by persons doing the conveyancing of the property on behalf of the purchaser and errors may occur when the data is being filed. In order to evaluate the spacial distribution of the property sold, a geocoding from the filled addresses to GPS coordinated was performed using the OpenStreetMap API.

```{r dublin-sample-size, results="asis"}
data_dublin_geocoded_clean %>%
  dplyr::count(year) %>%
  kable(
    "latex",
    caption = "Size of the PSRA database for properties sold in Dublin County per year since 2010 aftering filtering the orignal database.",
    booktabs = T,
    digits = 2,
    linesep = ""
  ) %>%
  kable_styling(font_size = 8,
                latex_options = c("hold_position"))
```

By focusing on the property sold in Dublin, `r nrow(data_dublin)` entries were recorded since 2010. After having filtered properties not corresponding to houses, properties for which address was not possible to geocode, artefacts in geocodes and abertant value in sales price. From the self-reported database, `r nrow(data_dublin_geocoded_clean)` properties sold in Dublin between `r min(data_dublin_geocoded_clean$date_of_sale)` and `r max(data_dublin_geocoded_clean$date_of_sale)` was geocoded (Table \ref{tab:dublin-sample-size}). 

Results
==========================

```{r distrib-plot, fig.cap="Distribution of the PSRA database (filtered)."}
data_dublin_geocoded_clean %>% 
  ggplot(aes(x = price, y = year_fact)) + 
  ggridges::geom_density_ridges_gradient(aes(fill = ..density..), size = 0.1)+
  scale_x_continuous("Price")+
  scale_y_discrete("")+
  theme_minimal() +
  theme(text = element_text(family = "serif", size=8))+ 
  scale_fill_gradientn(name = "Density",colours = colorRampPalette(c("white", blues9))(256))
```

The average properties price is `r round(mean_dat,0)` euros (SD = `r round(sd_dat,0)`). In order to remove potential human errors and outliers, prices higher or lower than 1 SD were removed from the original dataset (Figure \ref{fig:distrib-plot}).

```{r density-plot, fig.cap="Geographical density of the PSRA database (filtered)."}
autoplot(dublin_map) +
  stat_density_2d(data = data_dublin_geocoded_clean, aes(x = lng, y = lat, fill = ..level..), geom = "polygon", alpha = .2) +
  scale_fill_gradient2("Properties Sold\n(density)", low = "white", mid = "yellow", high = "red") +
  scale_x_continuous("Longitude") +
  scale_y_continuous("Latitude") +
  facet_wrap(~year) +
  theme_minimal() +
  theme(text = element_text(family = "serif", size=8),
        legend.position="bottom")
```

The distribution of properties sold in Dublin indicates that most of the properties sold are located around Dublin 6 and Dublin 6 West districts for every year investigated (Figure \ref{fig:density-plot}). However
in order to evaluate and to predict the distribution of housing prices, a generalised additive model with model soap film smoothers (Wood, Bravington and Hedley, 2008) is computed on the Dublin area. Soap film smoothers are constructing a 2-D smooth prediction of non-linear parameters such as latitude and longitude. The smooths are designed to fit geographical models including coastal boundaries.

```{r gam-model, cache=TRUE}
# https://www.fromthebottomoftheheap.net/2016/03/27/soap-film-smoothers/
# https://github.com/eric-pedersen/mgcv-esa-workshop/blob/master/example-spatial-mexdolphins-solutions.Rmd
# http://distancesampling.org/R/vignettes/mexico-analysis.html
#########################################################
#               get Dublin GPS box                      #
#########################################################
# https://wiki.openstreetmap.org/wiki/Map_Features
boundaries_dublin <- 
  osmdata::opq(bbox = 'Dublin, Ireland') %>%
  osmdata::add_osm_feature(key = 'admin_level', value = '7') %>%
  osmdata::osmdata_sf() %>% 
  osmdata::unique_osmdata()

bb <- st_bbox(boundaries_dublin$osm_multipolygons$geometry)
# Defining a buffer
buffer <- 0.1
p_big <- rbind(c(bb[1] - buffer, bb[2] - buffer),
               c(bb[1] - buffer, bb[4] + buffer),
               c(bb[3] + buffer, bb[4] + buffer),
               c(bb[3] + buffer, bb[2] - buffer),
               c(bb[1] - buffer, bb[2] - buffer))
# Putting the coordinates into a squared polygon object
pol_dublin <- st_polygon(list(p_big)) %>% st_geometry
# Providing the SRID (here, unprojected lon/lat)
st_crs(pol_dublin) <- 4326
#########################################################
#              get Dublin coast line                    #
#########################################################
coast_dublin <- opq(bbox = st_bbox(pol_dublin)) %>%
  add_osm_feature(key = 'natural', value = 'coastline') %>%
  osmdata_sf %>% unique_osmdata

blade_dublin <- coast_dublin$osm_lines$geometry %>% st_union %>% st_line_merge

ls <- st_linestring(blade_dublin[[1]][[1]])

multipol <- st_split(st_geometry(pol_dublin), st_geometry(ls))
#########################################################
#           define knots on Dublin ground               #
#########################################################
bound.grid.lng <- seq(from = bb[1],to = bb[3],len = 10)
bound.grid.lat<- seq(from = bb[2],to = bb[4],len = 10)

bound.grid.map <- expand.grid(lng = bound.grid.lng,lat = bound.grid.lat)

gam_boundaries <- multipol[[1]][[1]][[1]]

bound <- list(list(x = gam_boundaries[,1], y = gam_boundaries[,2], f = rep(0, nrow(gam_boundaries))))

names(bound.grid.map) <- c("x","y")

knots <- bound.grid.map[with(bound.grid.map, inSide(bound, x, y)), ]

names(knots) <- c("lng", "lat")
names(bound[[1]]) <- c("lng", "lat", "f")

# Remove pb knots ##############################################################
#knots <- knots[-38, ]
dublin_sea_frame <- multipol[[1]][[2]]

knots$pb <- apply(knots, 1, function(row) {  
    as.numeric(st_is_within_distance(dublin_sea_frame, st_point(c(row["lng"],row["lat"])), dist = 0.001))
})

knots_pb <- knots %>%
    dplyr::filter(pb == 1)

knots <- dplyr::anti_join(knots,knots_pb, by = c("lng", "lat"))
################################################################################
#                 gam soap film model                                          #
################################################################################
gam_dublin_gps <- mgcv::gam(
  price ~ s(lng, lat, bs = "so", xt = list(bnd = bound)), 
  data = data_dublin_geocoded_clean, 
  method = "REML", 
  knots = knots,
  #control=list(trace = TRUE),
  family=gaussian(link = "identity"))

res_gam_dublin_gps <- summary(gam_dublin_gps)

# check for k non significant
# gam.check(gam_dublin_gps)
```

In order to model the distibution of properties, a Generalized Additive Model using tweedie location scale family for Soap film smooths was calculated to fit the price of properties sold according to their GPS coordinates. The result indicates that `r scales::percent(res_gam_dublin_gps$dev.expl)` of property prices is explained by property localisation (*F*(`r res_gam_dublin_gps$n`,`r round(res_gam_dublin_gps$s.table[,"edf"],2)`) = `r round(res_gam_dublin_gps$s.table[,"F"], 2)`; *p* `r format.pval(res_gam_dublin_gps$s.table[,"p-value"], eps = 0.001)`).

```{r gam-plot, fig.cap="Prediction of property price according the GAM model."}
gam_plot <- function(data) {
  
gam_dublin_gps <- mgcv::gam(
  price ~ s(lng, lat, bs = "so", xt = list(bnd = bound)), 
  data = data, 
  method = "REML", 
  knots = knots,
  #control = list(trace = TRUE),
  #family = gaussian(link = "identity"),
  family = twlss())

my_viz(gam_dublin_gps, too.far = 0.05,n.grid = 30)

# grid.lng <- seq(from = bb[1],to = bb[3],by = 0.005)
# grid.lat <- seq(from = bb[2],to = bb[4],by = 0.005)
# grid.map <- expand.grid(lat = grid.lat, lng = grid.lng)
# pdata <- transform(grid.map, price = predict(gam_dublin_gps, grid.map, type = "response"))

}

gam_pred <- data_dublin_geocoded_clean %>%
  tidyr::nest(-year) %>%
  dplyr::mutate(year = as.factor(year),
                gam_data = purrr::map(data, ~ gam_plot(data = .)))%>%
  tidyr::unnest(gam_data)

gam_pred %>%
  dplyr::filter(value > 200000) %>%
  #dplyr::filter(value < 800000) %>%
  ggplot() +
  geom_raster(aes(x = lng, y = lat, fill = value)) +
  geom_sf(data=multipol[[1]][[2]], fill = "blue") +
  scale_fill_gradientn("Predicted Price (log)", colours = gradian_col, trans = "log", 
                       breaks = c(250000, 400000, 600000)) +
  scale_x_continuous("Longitude") +
  scale_y_continuous("Latitude") +
  facet_wrap(~year) +
  theme_minimal() +
  theme(text = element_text(family = "serif", size=8))
```

The Generalized Additive Model reveal not only high prices located on the coast of Dublin (i.e Dublin 4 and Dun Laoghaire) but also a spot in Dublin 7 which was un expected.

## Prediction of property price using XGBoost

In order to increase the prediction accuracy of the Generalized Additive Model an XGBoost regression was performed on 195 geographic, economic and social features.

### Geographical feature extraction using Open Street Map

Open Street map is a collaborative project which aims to create and provide access to free editable maps of the world. Open Street Map combines informations about more than 1177 features including road informations and building informations to categorize amenities, leisure or tourism structure for example. Among the 1177 features only 143 contain data for the Dublin Area (See list of Open Street Map features in Appendix 1). In order to process the XGBoost regression the distance between each property and the closest point corresponding to each of the 143 relevant Open Street Map. 

```{r}
data_dublin_2018_osm_features <- read_rds(here::here("data/data_dublin_2018_osm_features.rds")) %>% 
  dplyr::select_if(~sum(!is.na(.)) > 0)

amenity <- c(
  "amenity_bar",
  "amenity_college",                             
  "amenity_school",
  "amenity_university",                          
  "amenity_bicycle_parking",
  "amenity_fuel",                               
  "amenity_parking",
  "amenity_community_centre",                    
  "amenity_bench",
  "amenity_embassy",                            
  "amenity_police",
  "amenity_prison",                             
  "amenity_recycling"
)
barrier <- c(
  "barrier_city_wall",                           
  "barrier_ditch",                              
  "barrier_fence",                               
  "barrier_guard_rail",                         
  "barrier_hedge",                              
  "barrier_kerb",                               
  "barrier_retaining_wall",                      
  "barrier_wall",                               
  "barrier_block",                               
  "barrier_bollard",                            
  "barrier_chain",                               
  "barrier_full-height_turnstile",              
  "barrier_gate",                                
  "barrier_jersey_barrier",                     
  "barrier_yes"
)
boundary <- c(
  "boundary_administrative",                    
  "boundary_historic",                           
  "boundary_political",                         
  "boundary_postal_code",                        
  "boundary_protected_area"
)
building <- c(
  "building_apartments",                         
  "building_house",                             
  "building_residential",                        
  "building_commercial",                        
  "building_industrial",                         
  "building_retail",                           
  "building_hospital",                           
  "building_university",                        
  "building_yes"
)
highway <- c(
  "highway_motorway",                           
  "highway_trunk",                              
  "highway_secondary",                          
  "highway_tertiary",                            
  "highway_unclassified",                       
  "highway_residential",                         
  "highway_service",                            
  "highway_motorway_link",                       
  "highway_trunk_link",                         
  "highway_secondary_link",                      
  "highway_tertiary_link",                      
  "highway_pedestrian",                          
  "highway_track",                              
  "highway_road",                                
  "highway_footway",                            
  "highway_steps",                               
  "highway_path",                               
  "highway_cycleway"
)
cycleway <- c(
  "cycleway_lane",                              
  "cycleway_opposite",                          
  "cycleway_opposite_lane",                     
  "cycleway_track",                              
  "cycleway_share_busway",                      
  "cycleway_shared_lane"
)
busway <- c(
  "busway_lane"
)
highway <- c(
  "highway_proposed",                            
  "highway_construction" 
)
junction <- c(
  "junction_roundabout"
)
historic <- c(
  "historic_yes"
)
landuse <- c(
  "landuse_commercial",                          
  "landuse_construction",                       
  "landuse_industrial" ,                         
  "landuse_residential",                        
  "landuse_retail",                              
  "landuse_farmland",                           
  "landuse_grass",                               
  "landuse_military",                           
  "landuse_railway",                             
  "landuse_recreation_ground",                  
  "landuse_religious"
)
leisure <- c(
  "leisure_nature_reserve",                     
  "leisure_park",                                
  "leisure_slipway",                            
  "leisure_sports_centre",                      
  "leisure_stadium",                            
  "leisure_track"
)
man_made <- c(
  "man_made_breakwater",                        
  "man_made_crane",                              
  "man_made_embankment",                        
  "man_made_groyne",                            
  "man_made_pier",                              
  "man_made_pipeline"
)
natural <- c(
  "natural_wood",                               
  "natural_tree_row",                            
  "natural_scrub",                             
  "natural_grassland",                           
  "natural_water",                              
  "natural_beach",                               
  "natural_coastline",                          
  "natural_ridge",                               
  "natural_cliff"
)

place <- c(
  "place_district",                              
  "place_county",                               
  "place_city",                                  
  "place_suburb",                               
  "place_island",                                
  "place_locality"
)
power <- c(
  "power_cable",
  "power_line",
  "power_minor_line",                           
  "power_portal" 
)
line <- c(
  "line_busbar"
)

public_transport <- c(
  "public_transport_platform",                 
  "public_transport_stop_area"                  
)
railway <- c(
  "railway_abandoned",                          
  "railway_disused",                             
  "railway_rail",                               
  "railway_tram",
  "railway_platform"
)
bridge <- c(
  "bridge_yes"
)

cutting <- c(
  "cutting_yes"                                 
)
electrified_contact <- c(
  "electrified_contact_line"                   
)
embankment <- c(
  "embankment_yes"                              
)
service <- c(
  "service_crossover",                          
  "service_siding",                              
  "service_spur",
  "service_yard"                                
)

tunnel <- c(
  "tunnel_yes"
)
usage <- c(
  "usage_main"                                  
)

route <- c(                       
  "route_bicycle",                               
  "route_bus",                                  
  "route_ferry",                                 
  "route_hiking",                               
  "route_power",                                 
  "route_road",                                 
  "route_train",                                 
  "route_tram"
)                                 
shop <- c(  
  "shop_paint",                                  
  "shop_kitchen",                               
  "sport_badminton",                             
  "sport_equestrian",                           
  "sport_gaelic_games",                          
  "sport_rugby_union",                          
  "sport_running"
)

tourism <- c(
  "tourism_artwork",                            
  "tourism_zoo"                                 
)

waterway <- c(
  "waterway_river",                             
  "waterway_riverbank",                          
  "waterway_stream",                            
  "waterway_canal",                              
  "waterway_drain",                            
  "waterway_ditch",                              
  "waterway_weir",                              
  "waterway_lock_gate"
)

source <- c(
  "source_survey"                              
)
area <- c(
  "area_yes"
)
covered <- c(
  "covered_yes" 
)
disused <- c(
  "disused_yes"
)
tidal <- c(
  "tidal_yes" 
)

tbl_y <- data_dublin_2018_osm_features_aero %>%
  dplyr::select(price) %>% 
  as.matrix()
tbl_x <- data_dublin_2018_osm_features_aero %>%
  dplyr::select(amenity,
                barrier,
                boundary,
                building,
                highway,
                cycleway,
                busway,
                highway,
                junction,
                historic,
                landuse,
                leisure,
                man_made,
                natural,
                place,
                power,
                line,
                public_transport,
                railway,
                bridge,
                cutting,
                electrified_contact,
                embankment,
                service,
                tunnel,
                usage,
                route,                       
                shop,  
                tourism,
                waterway,
                source,
                area,
                covered,
                disused,
                tidal) %>% 
  as.matrix()

xgmodel <- xgboost::xgboost(
  data = tbl_x,
  label = tbl_y,
  objective = "reg:linear",
  eval_metric = "rmse",
  #booster = "gblinear",
  verbose = 1,
  nround = 200
)
pred <- predict(xgmodel, tbl_x)

result <- data.frame(pred = pred, raw = tbl_y)

lm_result <- lm(pred ~ price,result)

summary(lm_result)

importance_matrix <- xgb.importance(model = xgmodel)

importance_matrix %>% 
  dplyr::filter(Gain > 0.01) %>% 
  #dplyr::mutate_if(is.numeric, scales::percent, accuracy = 0.1) %>% 
  ggplot(aes(reorder(Feature, -Gain), Gain)) +
  geom_col() +
  scale_x_discrete(name = "Geographical feature") +
  scale_y_continuous(name = "Importance",
                   labels = scales::percent,
                   limits = c(0,1)
                   ) +
  theme_minimal() +
  theme(text = element_text(size=18,family="serif"),
        axis.text.x = element_text(angle = 45, hjust = 0.75,vjust=0.9),
        strip.text.x = element_text(face="bold",size=18),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        legend.text = element_text(size=8),
        legend.position = "bottom")
```


### Economic and social feature extraction using Irish Census

The results of Irish 2011 census consulation is accessible through the All-Island Research Observatory (http://airo.maynoothuniversity.ie/) and can be mapped over ireland small area boundaries which are fraction of irish Electoral Division map. The social features extracted are corresponding to population information, religion, carers and health. Economic features correspond to the type of each small area including the proportion of housing type, rooms number, occupancy and tenure per small area. Each property is then associated to the value corresponding to its small area.

```{r}
data_dublin_2018_osm_features <- read_rds(here::here("data/data_dublin_2018_osm_features.rds")) %>% 
  dplyr::select_if(~sum(!is.na(.)) > 0) %>% 
  dplyr::mutate(GEOG_ID = stringr::str_remove(GEOGID,"[A]"))

list_geoid <- unique(data_dublin_2018_osm_features$GEOG_ID)
################################################################################
carers <- read_csv(here::here("data/aero_data/carers.csv")) %>% 
  dplyr::filter(GEOG_ID %in% list_geoid)

disabilty_age_group <- read_csv(here::here("data/aero_data/disabilty_age_group.csv")) %>% 
  dplyr::filter(GEOG_ID %in% list_geoid)

general_health <- read_csv(here::here("data/aero_data/general_health.csv")) %>% 
  dplyr::filter(GEOG_ID %in% list_geoid)

housing_occupancy <- read_csv(here::here("data/aero_data/housing_occupancy.csv")) %>% 
  dplyr::filter(GEOG_ID %in% list_geoid)

housing_rooms <- read_csv(here::here("data/aero_data/housing_rooms.csv")) %>% 
  dplyr::filter(GEOG_ID %in% list_geoid)

housing_tenure <- read_csv(here::here("data/aero_data/housing_tenure.csv")) %>% 
  dplyr::filter(GEOG_ID %in% list_geoid)

housing_type <- read_csv(here::here("data/aero_data/housing_type.csv")) %>% 
  dplyr::filter(GEOG_ID %in% list_geoid)

population <- read_csv(here::here("data/aero_data/population.csv")) %>% 
  dplyr::filter(GEOG_ID %in% list_geoid)

religion <- read_csv(here::here("data/aero_data/religion.csv")) %>% 
  dplyr::filter(GEOG_ID %in% list_geoid)
################################################################################
data_dublin_2018_osm_features_aero <- data_dublin_2018_osm_features %>% 
  dplyr::left_join(carers, by = "GEOG_ID") %>% 
  dplyr::left_join(disabilty_age_group, by = "GEOG_ID") %>% 
  dplyr::left_join(general_health, by = "GEOG_ID") %>% 
  dplyr::left_join(housing_occupancy, by = "GEOG_ID") %>% 
  dplyr::left_join(housing_rooms, by = "GEOG_ID") %>% 
  dplyr::left_join(housing_tenure, by = "GEOG_ID") %>% 
  dplyr::left_join(housing_type, by = "GEOG_ID") %>% 
  dplyr::left_join(population, by = "GEOG_ID") %>% 
  dplyr::left_join(religion, by = "GEOG_ID")
################################################################################

carers <- c(              
  "% Provides No Care",                          
  "% 1-19 hours unpaid PW",                     
  "% 20-49 hours unpaid PW",                     
  "% 50+ hours unpaid PW",                      
  "% Total Care Providers"                      
)
disabilty_age_group <- c(
  "% Persons with a disability aged 0-14",      
  "% Persons with a disability aged 15 - 44",    
  "% Persons with a disability aged 25 - 44",   
  "% Persons with a disability aged 45 - 64",    
  "% Persons with a disability aged 65 Plus",   
  "% Total persons with a disability" 
)

general_health <- c(
  "% Very Good",                                
  "% Good",                                     
  "% Fair",                                     
  "% Bad",                                       
  "% Very Bad"
)

housing_occupancy <- c(
  "% Occupied/HS With ususal Residents",         
  "%  Unoccupied/HS Without Ususal Residents" 
)
housing_rooms <- c(
  "% 1 Room (Households)",                      
  "% 2 Rooms (Households)",                      
  "% 3 Rooms (Households)",                     
  "% 4 Rooms (Households)",                      
  "% 5 Rooms (Households)",                     
  "% 6 Rooms (Households)",                      
  "% 7 Rooms (Households)",                     
  "% 8 or more Rooms (Households)",              
  "% Total (Households).x"
)
housing_tenure <- c(
  "% Owner Occupier with Mortgage (Households)",
  "% Owner Occupier No Mortgage (Households)",   
  "% Private Rented",                           
  "% Social Rented",                             
  "% Rented Free of Rent (Households)",        
  "% Total (Households).y"  
)                               
housing_type <- c(
  "% House/Bungalow",                           
  "% Flat/Apartment/BedSit",                     
  "% Caravan/Mobile home/Temperory" 
)               
population <- c(
  "PC_MALE",                                     
  "PC_FEMALE",                                  
  "PCAGE014T",                                   
  "PCAGE1524T",                                 
  "PCAGE2544T",                                  
  "PCAGE4564",                                  
  "PCAEG65P",                                    
  "PCAGE1564",                                  
  "PCAGE80P"
)

religion <- c(
  "PC_RO_CATH",                                 
  "PC_OTH_C",                                   
  "PC_NC_OTH",                                  
  "PC_NS",                                       
  "PC_NO_REL"
)
################################################################################
tbl_y <- data_dublin_2018_osm_features_aero %>%
  dplyr::select(price) %>% 
  as.matrix()
tbl_x <- data_dublin_2018_osm_features_aero %>%
  dplyr::select(carers,              
                disabilty_age_group,
                general_health,
                housing_occupancy,
                housing_rooms,
                housing_tenure,
                housing_type,
                population,
                religion) %>% 
  as.matrix()

xgmodel <- xgboost::xgboost(
  data = tbl_x,
  label = tbl_y,
  objective = "reg:linear",
  eval_metric = "rmse",
  #booster = "gblinear",
  verbose = 1,
  nround = 200
)
pred <- predict(xgmodel, tbl_x)

result <- data.frame(pred = pred, raw = tbl_y)

lm_result <- lm(pred ~ price,result)

summary(lm_result)

importance_matrix <- xgb.importance(model = xgmodel)

importance_matrix %>% 
  dplyr::filter(Gain > 0.01) %>% 
  #dplyr::mutate_if(is.numeric, scales::percent, accuracy = 0.1) %>% 
  ggplot(aes(reorder(Feature, -Gain), Gain)) +
  geom_col() +
  scale_x_discrete(name = "Geographical feature") +
  scale_y_continuous(name = "Importance",
                   labels = scales::percent,
                   limits = c(0,1)
                   ) +
  theme_minimal() +
  theme(text = element_text(size=18,family="serif"),
        axis.text.x = element_text(angle = 45, hjust = 0.75,vjust=0.9),
        strip.text.x = element_text(face="bold",size=18),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        legend.text = element_text(size=8),
        legend.position = "bottom")
```


################################################################################

```{r}
# convert data to sf class
data_sf <- st_as_sf(data_dublin_geocoded_clean, coords = c("lng", "lat"))
st_crs(data_sf) <- st_crs(4326) # assign crs
data_sf <- st_transform(data_sf, crs = 32721) # transform
```

```{r}
# obtain gps coordinates of geographic variables (e.g., cycle lanes)
variable_osm <- osmdata::opq('Dublin, Ireland') %>%
  osmdata::add_osm_feature(key = 'bicycle', value = 'designated')
  
# variable_osm %>% 
#   osmdata::osmdata_sp() %>% 
#   magrittr::use_series(osm_points) %>% 
#   sp::plot()

variable_sf <- variable_osm %>% 
  osmdata::osmdata_sf() %>%
  magrittr::use_series(osm_lines) %>% 
  magrittr::use_series(geometry) %>% 
  st_sf()

st_crs(variable_sf) <- st_crs(4326) # assign crs
variable_sf <- st_transform(variable_sf, crs = 32721) # transform
variable_sf <- st_combine(variable_sf)

# distance
data_dublin_geocoded_clean$variable <- as.numeric(st_distance(x = data_sf, y = variable_sf))

gam_dublin_gps <- mgcv::gam(
  price ~ s(lng, lat, bs = "so", xt = list(bnd = bound)) + s(variable), 
  data = subset(data_dublin_geocoded_clean,year == 2010), 
  method = "REML", 
  knots = knots,
  #control=list(trace = TRUE),
  control = gam.control(nthreads = 3),
  family=gaussian(link = "identity"))

summary(gam_dublin_gps)
```


Conclusion
==========================

Using Generalized Additive Model we were able to identify the influence of property locations based in Dublin, Ireland on their actual sale price. 

Appendix
==========================

```{r}
OSM_dublin_features <- read_csv(here::here("data/OSM_dublin_features.csv"))
```


References {#references .unnumbered}
==========
